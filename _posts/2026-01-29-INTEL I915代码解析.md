---
layout: single
title: "INTEL I915代码解析"
date: 2026-01-29 17:00:00 +0800
categories: 技术 虚拟化
tags: [GPU, SR-IOV, Intel, I915]
excerpt: "I915是比较典型的通过SR-IOV实现虚拟化的例子，是一种完整的GPU虚拟化解决方案，允许多个虚拟机共享物理GPU。"
---

# INTEL I915代码解析



# 前言

I915是比较典型的通过`SR-IOV(Single Root I/O Virtualization)`实现虚拟化的例子，是一种完整的GPU虚拟化解决方案，允许多个虚拟机共享物理GPU。

GVT 是 **GPU Virtualization Technology** (GPU 虚拟化技术) 的缩写，是 Intel 开发的一项 GPU 虚拟化解决方案。

1. GVT-g：分时复用，完整虚拟化，接近原生性能，强隔离性
2. GVT-s：GPU 直通（SR-IOV），原生性能，最强隔离性
3. GVT-d: 整个 GPU 直通给单个 VM，原生性能

## 核心设计理念

* 时间片共享：物理GPU在多个vGPU之间进行时间片分片调度
* Mediated Device模型：给予Linux mdev框架和VFIO实现设备直通
* 分离驱动模型：Guest驱动修改+Host虚拟化模块

## 源码走读

```c
static const struct intel_gvt_ops intel_gvt_ops = {
	.emulate_cfg_read = intel_vgpu_emulate_cfg_read,
	.emulate_cfg_write = intel_vgpu_emulate_cfg_write,
	.emulate_mmio_read = intel_vgpu_emulate_mmio_read,
	.emulate_mmio_write = intel_vgpu_emulate_mmio_write,
	.vgpu_create = intel_gvt_create_vgpu,
	.vgpu_destroy = intel_gvt_destroy_vgpu,
	.vgpu_release = intel_gvt_release_vgpu,
	.vgpu_reset = intel_gvt_reset_vgpu,
	.vgpu_activate = intel_gvt_activate_vgpu,
	.vgpu_deactivate = intel_gvt_deactivate_vgpu,
	.vgpu_query_plane = intel_vgpu_query_plane,
	.vgpu_get_dmabuf = intel_vgpu_get_dmabuf,
	.write_protect_handler = intel_vgpu_page_track_handler,
	.emulate_hotplug = intel_vgpu_emulate_hotplug,
};
```

这个操作表提供了 GVT 核心功能给 hypervisor 模块使用，包括：
- **配置空间模拟**: PCI 配置空间的读写模拟
- **MMIO 模拟**: MMIO 寄存器的读写模拟
- **vGPU 生命周期管理**: 创建、销毁、重置、激活、停用
- **显示相关**: 查询平面、获取 dmabuf
- **内存管理**: 写保护处理
- **热插拔模拟**: 设备热插拔

![image-20260130173818164](/assets/image-20260130173818164.png)

![image-20260130175200855](/assets/image-20260130175200855.png)
